<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>è‹±å˜èªæš—è¨˜ã‚¢ãƒ—ãƒª by Koji NIHEI 2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
body{
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background:#fff5fb;
  padding:2vw;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}
.screen{ display:none; }
.card{
  background:white;
  padding:3vw;
  border-radius:18px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
  margin-bottom:4vw;
}
h3 {
  font-size: 4.5vw;
  color: #444;
  margin: 4vw 1vw 2vw 1vw;
  border-left: 5px solid #ff9bcd;
  padding-left: 10px;
}
button{
  padding:3vw 5vw;
  border-radius:20px;
  border:none;
  font-size:4vw;
  margin:1.5vw;
  cursor: pointer;
  transition: transform 0.1s, opacity 0.1s;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
button:active{ transform: scale(0.96); opacity: 0.8; }

.btn-blue{ background:#9bd8ff; color:#004085; width: 90%; text-align:left; }
.btn-green{ background:#9be1a7; color:#155724; }
.btn-pink{ background:#ff9bcd; color:#721c24; }
.btn-gray{ background:#dddddd; color:#333; }

/* ã‚²ãƒ¼ãƒ ç”¨ã®é¸æŠè‚¢ãƒœã‚¿ãƒ³ */
.btn-choice{
  width: 100%;
  margin: 2vw 0;
  padding: 4vw;
  font-size: 5vw;
  background: #f0f8ff;
  border: 2px solid #9bd8ff;
  border-radius: 12px;
  color: #333;
  text-align: left;
  font-weight: bold;
}

.big{
  font-size:10vw;
  margin:6vw 0;
  text-align:center;
  cursor:pointer;
  font-weight: bold;
  word-break: break-word;
}
#infoBar{
  position:fixed;
  bottom:0;
  left: 0;
  width: 100%;
  background:rgba(255,255,255,0.95);
  border-top: 1px solid #eee;
  padding:3vw;
  text-align: center;
  box-shadow:0 -2px 6px rgba(0,0,0,0.05);
  font-size: 3.5vw;
  z-index: 100;
  box-sizing: border-box;
}

/* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã‚¹ã‚¤ãƒƒãƒ */
.mode-switch {
  display: flex;
  justify-content: center;
  margin-bottom: 4vw;
  background: #eee;
  border-radius: 25px;
  padding: 1vw;
}
.mode-option {
  flex: 1;
  text-align: center;
  padding: 2.5vw;
  border-radius: 20px;
  cursor: pointer;
  font-size: 4vw;
  color: #888;
  transition: 0.3s;
}
.mode-active {
  background: #ff9bcd;
  color: white;
  font-weight: bold;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}

/* ã‚¹ã‚³ã‚¢è¡¨ç¤º */
.score-board {
  text-align: center;
  font-size: 6vw;
  color: #ff9bcd;
  font-weight: bold;
  margin-bottom: 2vw;
}

/* ãƒªã‚¹ãƒˆãŒãªã„æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.no-list-msg {
    text-align: center;
    color: #999;
    padding: 5vw;
}
</style>
</head>

<body>

<div id="listScreen" class="screen" style="display:block;">
  <div class="card">
    <div style="text-align:center; font-size:5vw; font-weight:bold; margin-bottom:4vw; color:#555;">
      è‹±å˜èªã‚¢ãƒ—ãƒª 2026
    </div>
    
    <div class="mode-switch">
      <div id="modeStudy" class="mode-option mode-active" onclick="setMode('study')">âš¡ é€Ÿæ”»</div>
      <div id="modeGame" class="mode-option" onclick="setMode('game')">ğŸ® ã‚²ãƒ¼ãƒ </div>
    </div>
    
    <div style="text-align:center; font-size:3.5vw; color:#888; margin-bottom:2vw;">
      ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã‹ã‚‰<br>ä¸‹ã®ãƒªã‚¹ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„
    </div>
  </div>

  <div class="card">
    <h3>ğŸ“˜ åŸºæœ¬ã‚³ãƒ¼ã‚¹</h3>
    <div id="basicList" style="text-align:center;"></div>

    <h3>ğŸ“• ä¸­ç´šã‚³ãƒ¼ã‚¹</h3>
    <div id="intermediateList" style="text-align:center;"></div>
  </div>

  <div class="card">
    <h3>ğŸ“Š å­¦ç¿’è¨˜éŒ²</h3>
    <div style="text-align:center;">
        <canvas id="studyChart" width="320" height="200"></canvas>
    </div>
  </div>
  
  <div style="height:15vw;"></div> </div>

<div id="studyScreen" class="screen card" style="min-height: 80vh;">
  <div style="text-align:center;color:#888;margin-bottom:4vw;">âš¡ é€Ÿæ”»ãƒ¢ãƒ¼ãƒ‰</div>
  
  <div class="big" id="questionWord" onclick="speakQuestion()"></div>
  <div class="big" id="answerMeaning" style="color:#0077ff;" onclick="speakAnswer()"></div>

  <div style="text-align:center; margin-top:10vw;">
    <button class="btn-green" onclick="markKnow()">åˆ†ã‹ã‚‹</button>
    <button class="btn-pink" onclick="markDontKnow()">åˆ†ã‹ã‚‰ãªã„</button>
  </div>
  <div style="text-align:center; margin-top:8vw;">
    <button class="btn-gray" onclick="endStudy()">çµ‚äº†ã—ã¦æˆ»ã‚‹</button>
  </div>
</div>

<div id="gameScreen" class="screen card" style="min-height: 80vh;">
  <div class="score-board">SCORE: <span id="gameScore">0</span></div>
  <div class="big" id="gameQuestionWord" style="margin-bottom:5vw;"></div>
  
  <div id="choicesArea"></div>

  <div id="gameFeedback" style="text-align:center; font-size:6vw; height:8vw; margin-top:2vw; font-weight:bold;"></div>

  <div style="text-align:center; margin-top:8vw;">
    <button class="btn-gray" onclick="endStudy()">çµ‚äº†ã—ã¦æˆ»ã‚‹</button>
  </div>
</div>

<div id="infoBar">
  <div id="studyInfo">èª­è¾¼ä¸­...</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ===== â˜…ã“ã“ã«å˜èªãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥æ›¸ãè¾¼ã¿ã¾ã™ï¼ˆCSVä¸è¦ï¼‰â˜… =====
// å¥½ããªã ã‘ãƒªã‚¹ãƒˆã‚’è¿½åŠ ã§ãã¾ã™
const builtInLists = {
  basic: [
    {
      title: "åŸºæœ¬å˜èª Part 1",
      words: [
        {word: "Apple", meaning: "ã‚Šã‚“ã”"},
        {word: "Dog", meaning: "çŠ¬"},
        {word: "Cat", meaning: "çŒ«"},
        {word: "Book", meaning: "æœ¬"},
        {word: "Desk", meaning: "æœº"},
        {word: "Chair", meaning: "æ¤…å­"},
        {word: "Run", meaning: "èµ°ã‚‹"},
        {word: "Eat", meaning: "é£Ÿã¹ã‚‹"},
        {word: "Study", meaning: "å‹‰å¼·ã™ã‚‹"},
        {word: "Play", meaning: "éŠã¶"}
      ]
    },
    {
      title: "æŒ¨æ‹¶ãƒ»æ—¥å¸¸",
      words: [
        {word: "Hello", meaning: "ã“ã‚“ã«ã¡ã¯"},
        {word: "Good morning", meaning: "ãŠã¯ã‚ˆã†"},
        {word: "Thank you", meaning: "ã‚ã‚ŠãŒã¨ã†"},
        {word: "Sorry", meaning: "ã”ã‚ã‚“ãªã•ã„"},
        {word: "Yes", meaning: "ã¯ã„"},
        {word: "No", meaning: "ã„ã„ãˆ"}
      ]
    }
  ],
  intermediate: [
    {
      title: "ä¸­ç´šå˜èª Part 1",
      words: [
        {word: "Understand", meaning: "ç†è§£ã™ã‚‹"},
        {word: "Difficult", meaning: "é›£ã—ã„"},
        {word: "Important", meaning: "é‡è¦ãª"},
        {word: "Beautiful", meaning: "ç¾ã—ã„"},
        {word: "Experience", meaning: "çµŒé¨“"},
        {word: "Environment", meaning: "ç’°å¢ƒ"}
      ]
    }
  ]
};

// ===== Firebase åˆæœŸåŒ– =====
firebase.initializeApp({
  apiKey: "AIzaSyAYEEHtYUdDylKlSwy4mX2S2mIK5Hs3vJA",
  authDomain: "english-word-app-f7101.firebaseapp.com",
  projectId: "english-word-app-f7101",
});
const db = firebase.firestore();

// ===== å…±é€šå¤‰æ•° =====
let userId = localStorage.getItem("userId");
if(!userId){
  userId = crypto.randomUUID();
  localStorage.setItem("userId", userId);
}

let studyStartTime = null;
let currentList = [];
let appMode = 'study'; // 'study' or 'game'

// ===== æ™‚é–“ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
const today = () => new Date().toISOString().slice(0,10);
const formatTime = sec => {
  const m = Math.floor(sec/60);
  const h = Math.floor(m/60);
  return h ? `${h}æ™‚é–“${m%60}åˆ†` : `${m}åˆ†`;
};

// ===== Firestore =====
async function saveClearCount(title){
  try{
    const ref=db.collection("users").doc(userId).collection("clearedLists").doc(title);
    const s=await ref.get();
    await ref.set({count:(s.exists?s.data().count:0)+1});
  }catch(e){}
}
async function loadClearCounts(){
  try{
    const s=await db.collection("users").doc(userId).collection("clearedLists").get();
    let m={}; s.forEach(d=>m[d.id]=d.data().count); return m;
  }catch(e){return {};}
}
async function saveStudyTime(sec){
  try{
    const ref=db.collection("users").doc(userId).collection("studyTime").doc(today());
    const s=await ref.get();
    await ref.set({seconds:(s.exists?s.data().seconds:0)+sec});
  }catch(e){}
}
async function loadStudyTimes(){
  try{
    const s=await db.collection("users").doc(userId).collection("studyTime").get();
    let m={}; s.forEach(d=>m[d.id]=d.data().seconds); return m;
  }catch(e){return {};}
}

// ===== è¡¨ç¤ºãƒ»ãƒ¢ãƒ¼ãƒ‰ç®¡ç† =====
async function updateStudyInfo(){
  const d=await loadStudyTimes();
  const t=d[today()]||0;
  const sum=Object.values(d).reduce((a,b)=>a+b,0);
  document.getElementById("studyInfo").innerText=`ğŸ“˜ ä»Šæ—¥ï¼š${formatTime(t)} / ç´¯è¨ˆï¼š${formatTime(sum)}`;
}

async function drawStudyChart(){
  const d=await loadStudyTimes();
  const e=Object.entries(d).sort().slice(-7);
  const c=document.getElementById("studyChart");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  if(!e.length) return;
  const vals=e.map(v=>Math.floor(v[1]/60));
  const max=Math.max(...vals,1);
  vals.forEach((v,i)=>{
    const h=v/max*120;
    ctx.fillStyle="#ff9bcd";
    ctx.fillRect(30+i*40,160-h,24,h);
    ctx.fillStyle="#555";
    ctx.fillText(e[i][0].slice(5),28+i*40,180);
  });
}

function setMode(mode){
  appMode = mode;
  document.getElementById('modeStudy').className = mode === 'study' ? 'mode-option mode-active' : 'mode-option';
  document.getElementById('modeGame').className = mode === 'game' ? 'mode-option mode-active' : 'mode-option';
}

// ===== ãƒªã‚¹ãƒˆèª­è¾¼ï¼ˆå†…è”µãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰ =====
async function loadAllLists(){
  const counts = await loadClearCounts();
  
  const make=(listData, id)=>{
    const c=document.getElementById(id);
    c.innerHTML="";
    if(!listData || listData.length === 0){
        c.innerHTML = "<div class='no-list-msg'>ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>";
        return;
    }
    listData.forEach(item => {
      const b=document.createElement("button");
      b.className="btn-blue";
      b.innerText = item.title + (counts[item.title]?`ï¼ˆ${counts[item.title]}å›ã‚¯ãƒªã‚¢ï¼‰`:"");
      
      // ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‹•ä½œ
      b.onclick = () => {
         // ãã®ãƒªã‚¹ãƒˆã®å˜èªãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã—ã¦é–‹å§‹
         startSession(item.title, item.words);
      };
      c.appendChild(b);
    });
  };
  
  make(builtInLists.basic, "basicList");
  make(builtInLists.intermediate, "intermediateList");
  
  await updateStudyInfo();
  await drawStudyChart();
  show("listScreen");
}

// ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ =====
function startSession(title, words){
  studyStartTime = Date.now();
  // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ã†
  currentList = JSON.parse(JSON.stringify(words));
  
  if(appMode === 'study'){
    startStudyMode(title);
  } else {
    startGameMode(title);
  }
}

// ============================================
// âš¡ é€Ÿæ”»ãƒ¢ãƒ¼ãƒ‰
// ============================================
let studyOrder=[], studyIndex=0, dontKnow=[], studyTitle="", round=1;

function startStudyMode(t){
  studyTitle=t; round=1; studyIndex=0; dontKnow=[];
  studyOrder=[...currentList.keys()].sort(()=>Math.random()-0.5);
  show("studyScreen");
  nextQuestion();
}

function nextQuestion(){
  if(studyIndex>=studyOrder.length){
    if(!dontKnow.length){
      saveClearCount(studyTitle);
      alert("ã™ã¹ã¦æ­£è§£ã§ã™ï¼ã‚¯ãƒªã‚¢ï¼");
      return endStudy(true);
    }
    currentList=dontKnow.map(i=>currentList[i]);
    dontKnow=[]; round++; studyIndex=0;
    studyOrder=[...currentList.keys()];
  }
  const it=currentList[studyOrder[studyIndex]];
  document.getElementById("questionWord").innerText=it.word;
  document.getElementById("answerMeaning").innerText="";
}

function markKnow(){ 
  showAnswer(); 
  speakAnswer(); 
  setTimeout(()=>{studyIndex++;nextQuestion();},700); 
}
function markDontKnow(){ 
  dontKnow.push(studyOrder[studyIndex]); 
  showAnswer(); 
  speakAnswer(); 
  setTimeout(()=>{studyIndex++;nextQuestion();},1200); 
}
function showAnswer(){ 
  document.getElementById("answerMeaning").innerText=currentList[studyOrder[studyIndex]].meaning; 
}

// ============================================
// ğŸ® ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼ˆéŸ³å£°å¼·åŒ–ç‰ˆï¼‰
// ============================================
let gameIndex=0, gameScore=0, gameOrder=[];

function startGameMode(t){
  gameIndex=0; gameScore=0;
  gameOrder=[...currentList.keys()].sort(()=>Math.random()-0.5);
  document.getElementById("gameScore").innerText = gameScore;
  show("gameScreen");
  nextGameQuestion();
}

function nextGameQuestion(){
  const feedback = document.getElementById("gameFeedback");
  feedback.innerText = "";
  
  if(gameIndex >= gameOrder.length){
    alert(`ã‚²ãƒ¼ãƒ çµ‚äº†ï¼\nã‚ãªãŸã®ã‚¹ã‚³ã‚¢: ${gameScore} / ${gameOrder.length}`);
    return endStudy(true);
  }
  
  const correctIdx = gameOrder[gameIndex];
  const correctItem = currentList[correctIdx];
  
  // 4æŠä½œæˆ
  let choices = [correctItem];
  let safetyLoop = 0;
  while(choices.length < 4 && safetyLoop < 100){
    safetyLoop++;
    const r = Math.floor(Math.random() * currentList.length);
    const item = currentList[r];
    if(!choices.includes(item) && item.meaning !== correctItem.meaning){
      choices.push(item);
    }
  }
  choices.sort(()=>Math.random()-0.5);

  document.getElementById("gameQuestionWord").innerText = correctItem.word;
  speak(correctItem.word);

  const area = document.getElementById("choicesArea");
  area.innerHTML = "";
  
  choices.forEach(c => {
    const btn = document.createElement("button");
    btn.className = "btn-choice";
    btn.innerText = c.meaning;
    btn.onclick = () => checkGameAnswer(c, correctItem);
    area.appendChild(btn);
  });
}

function checkGameAnswer(selected, correct){
  const area = document.getElementById("choicesArea");
  Array.from(area.children).forEach(b => b.disabled = true);
  const feedback = document.getElementById("gameFeedback");

  const playSequence = (phrase, word) => {
    speechSynthesis.cancel();
    const u1 = new SpeechSynthesisUtterance(phrase);
    u1.lang = "en-US";
    u1.rate = 1.1;
    const u2 = new SpeechSynthesisUtterance(word);
    u2.lang = "en-US";
    speechSynthesis.speak(u1);
    speechSynthesis.speak(u2);
  };

  if(selected.word === correct.word){
    // æ­£è§£
    gameScore++;
    document.getElementById("gameScore").innerText = gameScore;
    feedback.innerText = "â­• Excellent!";
    feedback.style.color = "green";
    
    playSequence("Good job!", correct.word);

    setTimeout(() => {
      gameIndex++;
      nextGameQuestion();
    }, 1500);
  } else {
    // ä¸æ­£è§£
    feedback.innerText = `âŒ æ­£è§£: ${correct.meaning}`;
    feedback.style.color = "red";
    
    playSequence("Try again.", correct.word);

    setTimeout(() => {
      gameIndex++;
      nextGameQuestion();
    }, 2500);
  }
}

// ===== å…±é€šãƒ»éŸ³å£° =====
function speak(t){ 
  if(!t) return; 
  speechSynthesis.cancel(); 
  const u = new SpeechSynthesisUtterance(t);
  u.lang = "en-US";
  speechSynthesis.speak(u); 
}
function speakQuestion(){ 
  if(appMode==='study') speak(document.getElementById("questionWord").innerText);
  else speak(document.getElementById("gameQuestionWord").innerText);
}
function speakAnswer(){ 
  if(appMode==='study') speak(document.getElementById("answerMeaning").innerText);
}

// ===== ç”»é¢é·ç§» =====
async function endStudy(auto){
  if(studyStartTime){
    await saveStudyTime(Math.floor((Date.now()-studyStartTime)/1000));
    studyStartTime=null;
  }
  if(!auto && !confirm("å­¦ç¿’ã‚’çµ‚äº†ã—ã¦ä¸€è¦§ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) return;
  loadAllLists();
}
function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}

// èµ·å‹•
loadAllLists();
</script>
</body>
</html>

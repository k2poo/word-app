<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>è‹±å˜èªæš—è¨˜ã‚¢ãƒ—ãƒª (Renamed Modes)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
/* === åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« (ã‚¹ãƒãƒ›å„ªå…ˆ) === */
body{
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background:#fff5fb;
  padding:2vw;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  padding-bottom: 25vw;
}
.screen{ display:none; }
.card{
  background:white;
  padding:3vw;
  border-radius:18px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
  margin-bottom:4vw;
}
h3 {
  font-size: 4.5vw;
  color: #444;
  margin: 4vw 1vw 2vw 1vw;
  border-left: 5px solid #ff9bcd;
  padding-left: 10px;
}
button{
  padding:3vw 5vw;
  border-radius:20px;
  border:none;
  font-size:4vw;
  margin:1.5vw;
  cursor: pointer;
  transition: transform 0.1s, opacity 0.1s;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
button:active{ transform: scale(0.96); opacity: 0.8; }
button:disabled{ opacity: 0.5; cursor: default; transform: none; }

.btn-blue{ background:#9bd8ff; color:#004085; width: 90%; text-align:left; }
.btn-green{ background:#9be1a7; color:#155724; }
.btn-pink{ background:#ff9bcd; color:#721c24; }
.btn-gray{ background:#dddddd; color:#333; }

/* ã‚²ãƒ¼ãƒ ç”¨é¸æŠè‚¢ */
.btn-choice{
  width: 100%;
  margin: 2vw 0;
  padding: 4vw;
  font-size: 5vw;
  background: #f0f8ff;
  border: 2px solid #9bd8ff;
  border-radius: 12px;
  color: #333;
  text-align: left;
  font-weight: bold;
}

/* ç¶´ã‚Šãƒ¢ãƒ¼ãƒ‰ç”¨ã®å…¥åŠ›ã‚¨ãƒªã‚¢ */
.input-area {
  text-align: center;
  margin: 4vw 0;
}
#inputAnswer {
  font-size: 8vw;
  width: 60%;
  padding: 2vw;
  text-align: center;
  border: 2px solid #9bd8ff;
  border-radius: 10px;
  outline: none;
  letter-spacing: 0.1em;
  background: #fdfdfd;
}
#inputAnswer:focus {
  border-color: #ff9bcd;
  background: #fffdf0;
}
#inputAnswer:disabled {
  background: #eee;
  color: #999;
  border-color: #ddd;
}

.hint-area {
  display: flex;
  justify-content: space-around;
  margin-bottom: 3vw;
}
.btn-hint {
  background: #fff3cd;
  color: #856404;
  border: 1px solid #ffeeba;
  font-size: 3.5vw;
  padding: 2vw 1vw;
  border-radius: 12px;
  width: 30%;
}

.big{
  font-size:10vw;
  margin:3vw 0;
  text-align:center;
  cursor:pointer;
  font-weight: bold;
  word-break: break-word;
  min-height: 12vw; 
}
/* ç¶´ã‚Šãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šæ„å‘³ã®è¡¨ç¤º */
.meaning-display {
  font-size: 6vw;
  color: #0077ff;
  text-align: center;
  margin: 2vw 0 2vw 0;
  font-weight: bold;
}

/* ç”»åƒè¡¨ç¤ºç”¨ */
.img-box {
  text-align: center;
  margin: 2vw 0;
  height: 30vw;
  display: flex;
  align-items: center;
  justify-content: center;
}
.img-box img {
  max-width: 100%;
  max-height: 100%;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.listening-msg {
  font-size: 5vw;
  color: #ff9bcd;
  animation: pulse 1.5s infinite;
  text-align: center;
  font-weight: bold;
}
@keyframes pulse {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}

#infoBar{
  position:fixed;
  bottom:0;
  left: 0;
  width: 100%;
  background:rgba(255,255,255,0.98);
  border-top: 1px solid #ddd;
  padding:2vw;
  text-align: center;
  box-shadow:0 -2px 8px rgba(0,0,0,0.1);
  font-size: 3.5vw;
  z-index: 100;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.auth-msg {
  font-size: 3vw;
  color: #e91e63;
  margin-bottom: 1.5vw;
  font-weight: bold;
}
.auth-btn {
  color: #0077ff;
  text-decoration: underline;
  cursor: pointer;
  margin-top: 1vw;
  font-size: 3.5vw;
}

/* --- ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ï¼ˆé•·ã„åå‰å¯¾å¿œï¼‰ --- */
.mode-switch {
  display: flex;
  flex-wrap: wrap; /* æŠ˜ã‚Šè¿”ã—ã‚’è¨±å¯ */
  gap: 2vw;        /* ãƒœã‚¿ãƒ³é–“ã®éš™é–“ */
  margin-bottom: 4vw;
}
.mode-option {
  width: 48%; /* 2åˆ—ã«ã™ã‚‹ãŸã‚å¹…ã‚’æŒ‡å®š */
  text-align: center;
  padding: 3vw 1vw;
  border-radius: 15px;
  cursor: pointer;
  font-size: 3.2vw;
  color: #666;
  background: #eee;
  transition: 0.2s;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 14vw; /* é«˜ã•æƒãˆ */
  line-height: 1.3;
}
.mode-active {
  background: #ff9bcd;
  color: white;
  font-weight: bold;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  transform: translateY(-2px);
}
#modeUrgent.mode-active { background: #ff6b6b; color: white; }
#modeSpelling.mode-active { background: #9bd8ff; color: #004085; }

.score-board {
  text-align: center;
  font-size: 6vw;
  color: #ff9bcd;
  font-weight: bold;
  margin-bottom: 2vw;
}

#loadingStatus {
    font-size: 3vw;
    color: #666;
    text-align: center;
    padding: 2vw;
    background: #f8f9fa;
    margin-bottom: 2vw;
    border-radius: 8px;
}

/* PC/Tablet */
@media (min-width: 768px) {
  body {
    max-width: 800px;
    margin: 0 auto;
    background-color: #f0f2f5;
    padding: 20px;
    font-size: 16px;
    padding-bottom: 120px;
  }
  .card { padding: 30px; margin-bottom: 30px; }
  h3 { font-size: 24px; margin: 20px 0 15px 0; }
  button { font-size: 18px; padding: 15px 20px; margin: 8px; }
  .mode-switch { margin-bottom: 20px; gap: 10px; }
  .mode-option { font-size: 16px; padding: 15px; min-height: 60px; }
  .big { font-size: 64px; margin: 40px 0; min-height: 80px; }
  .btn-choice { font-size: 20px; padding: 20px; margin: 10px 0; }
  .input-area #inputAnswer { font-size: 48px; width: 300px; }
  .meaning-display { font-size: 32px; margin: 20px 0; }
  .img-box { height: 200px; }
  .btn-hint { font-size: 16px; padding: 10px; width: 30%; }
  #infoBar { width: 800px; left: 50%; transform: translateX(-50%); font-size: 16px; padding: 15px; }
  .auth-msg { font-size: 14px; margin-bottom: 8px; }
  .auth-btn { font-size: 16px; margin-top: 5px; }
  #basicList, #intermediateList { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .listening-msg { font-size: 24px; }
  .score-board { font-size: 32px; }
}
</style>
</head>

<body>

<div id="listScreen" class="screen" style="display:block;">
  <div class="card">
    <div style="text-align:center; font-size:2em; font-weight:bold; margin-bottom:1em; color:#555;">
      è‹±å˜èªã‚¢ãƒ—ãƒª 2026
    </div>
    
    <div class="mode-switch">
      <div id="modeStudy" class="mode-option mode-active" onclick="setMode('study')">âš¡ ã‚¯ã‚¤ãƒƒã‚¯<br>ãƒãƒ£ãƒ¼ã‚¸</div>
      <div id="modeGame" class="mode-option" onclick="setMode('game')">ğŸ® ï¼”æŠã‚²ãƒ¼ãƒ </div>
      <div id="modeUrgent" class="mode-option" onclick="setMode('urgent')">ğŸ”¥ ã‚¿ã‚¤ãƒ <br>ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼</div>
      <div id="modeSpelling" class="mode-option" onclick="setMode('spelling')">âœï¸ ã‚¹ãƒšãƒªãƒ³ã‚°<br><span style="font-size:0.8em">(2æ–‡å­—è¨˜å…¥)</span></div>
    </div>
    
    <div style="text-align:center; font-size:0.9em; color:#888; margin-bottom:2vw;">
      ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã‹ã‚‰<br>ä¸‹ã®ãƒªã‚¹ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„
    </div>

    <div id="loadingStatus">æº–å‚™ä¸­...</div>
  </div>

  <div class="card">
    <h3 id="headerBasic">ğŸ“˜ åŸºæœ¬ã‚³ãƒ¼ã‚¹</h3>
    <div id="basicList" style="text-align:center;"></div>

    <h3 id="headerInter">ğŸ“• ä¸­ç´šã‚³ãƒ¼ã‚¹</h3>
    <div id="intermediateList" style="text-align:center;"></div>
  </div>

  <div class="card">
    <h3>ğŸ“Š å­¦ç¿’è¨˜éŒ²</h3>
    <div style="text-align:center;">
        <canvas id="studyChart" width="320" height="200"></canvas>
    </div>
  </div>
</div>

<div id="studyScreen" class="screen card" style="min-height: 80vh;">
  <div style="text-align:center;color:#888;margin-bottom:4vw;">âš¡ ã‚¯ã‚¤ãƒƒã‚¯ãƒãƒ£ãƒ¼ã‚¸</div>
  
  <div class="big" id="questionWord" onclick="speakQuestion()"></div>
  <div id="studyImageArea" class="img-box" style="display:none;"></div>
  
  <div class="big" id="answerMeaning" style="color:#0077ff;" onclick="speakAnswer()"></div>

  <div style="text-align:center; margin-top:10vw;">
    <button class="btn-green" onclick="markKnow()">åˆ†ã‹ã‚‹</button>
    <button class="btn-pink" onclick="markDontKnow()">åˆ†ã‹ã‚‰ãªã„</button>
  </div>
  <div style="text-align:center; margin-top:8vw;">
    <button class="btn-gray" onclick="endStudy()">çµ‚äº†ã—ã¦æˆ»ã‚‹</button>
  </div>
</div>

<div id="gameScreen" class="screen card" style="min-height: 80vh;">
  <div class="score-board">SCORE: <span id="gameScore">0</span></div>
  
  <div style="min-height:20vw; display:flex; flex-direction:column; align-items:center; justify-content:center; margin-bottom:4vw;">
      <div id="listeningMsg" class="listening-msg">ğŸµ ã‚ˆãèã„ã¦<br>(éŸ³å£°ã§å‡ºé¡Œä¸­)</div>
      <div id="gameImageArea" class="img-box" style="display:none;"></div>
      <div id="gameQuestionWord" class="big" style="display:none; margin:0;"></div>
  </div>

  <div class="hint-area">
      <button class="btn-hint" onclick="gameHint1()">ãƒ’ãƒ³ãƒˆ1<br>æ–‡å­—ã‚’è¡¨ç¤º</button>
      <button class="btn-hint" onclick="gameHint2()">ãƒ’ãƒ³ãƒˆ2<br>ã‚‚ã†ä¸€åº¦èã</button>
      <button class="btn-hint" onclick="gameHint3()">ãƒ’ãƒ³ãƒˆ3<br>ç­”ãˆã‚’èã</button>
  </div>
  
  <div id="choicesArea"></div>

  <div id="gameFeedback" style="text-align:center; font-size:1.2em; height:3em; margin-top:2vw; font-weight:bold; color:red;"></div>

  <div style="text-align:center; margin-top:8vw;">
    <button class="btn-gray" onclick="endStudy()">çµ‚äº†ã—ã¦æˆ»ã‚‹</button>
  </div>
</div>

<div id="spellingScreen" class="screen card" style="min-height: 80vh;">
  <div class="score-board">ROUND: <span id="spellingRoundDisplay">1</span></div>
  
  <div id="spellingImageArea" class="img-box" style="display:none;"></div>

  <div id="spellingMeaning" class="meaning-display"></div>
  
  <div class="big" id="spellingQuestionText" style="margin-bottom:0; font-family: monospace;" onclick="playSpellingAudio()"></div>
  
  <div class="input-area">
    <input type="text" id="inputAnswer" maxlength="2" autocomplete="off" placeholder="__" onkeydown="if(event.key==='Enter') checkSpellingAnswer()">
  </div>
  
  <div style="text-align:center;">
    <button class="btn-green" onclick="checkSpellingAnswer()">å›ç­”ã™ã‚‹</button>
    <button class="btn-blue" onclick="playSpellingAudio()">ğŸµ éŸ³å£°ã‚’èã(è‹±èª)</button>
  </div>

  <div id="spellingFeedback" style="text-align:center; font-size:1.2em; height:3em; margin-top:4vw; font-weight:bold; color:red;"></div>

  <div style="text-align:center; margin-top:8vw;">
    <button class="btn-gray" onclick="endStudy()">çµ‚äº†ã—ã¦æˆ»ã‚‹</button>
  </div>
</div>


<div id="infoBar">
  <div id="authMsg" class="auth-msg" style="display:none;">
    åŒã˜Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ç«¯æœ«ãŒé•ã£ã¦ã‚‚ã€<br>å­¦ç¿’ã®è¨˜éŒ²ãŒç´¯ç©ã•ã‚Œã¾ã™ã€‚<br>ãƒ­ã‚°ã‚¤ãƒ³ã—ãªã„ã¨ãã¯ã€ç«¯æœ«ã”ã¨ã«ç´¯ç©ã•ã‚Œã¾ã™ã€‚
  </div>
  <div id="studyInfo" style="font-weight:bold; color:#555;">...</div>
  <div id="authBtn" class="auth-btn" onclick="toggleAuth()">
    Googleã§ãƒ­ã‚°ã‚¤ãƒ³
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// ===== â˜…ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ãƒ‡ãƒ¼ã‚¿ â˜… =====
const BACKUP_DATA = {
  basic: [
    {title: "åŸºæœ¬å˜èª1(Backup)", file:"backup_basic", data:[{word:"1",meaning:"one"},{word:"2",meaning:"two"}]},
    {title: "åŸºæœ¬å˜èª2(Backup)", file:"backup_basic2", data:[{word:"Hello",meaning:"ã“ã‚“ã«ã¡ã¯"}]}
  ],
  inter: []
};

// ===== Firebase =====
try {
  firebase.initializeApp({
    apiKey: "AIzaSyAYEEHtYUdDylKlSwy4mX2S2mIK5Hs3vJA",
    authDomain: "english-word-app-f7101.firebaseapp.com",
    projectId: "english-word-app-f7101",
  });
} catch(e) { console.error(e); }
const db = firebase.firestore();
const auth = firebase.auth();

// ===== å¤‰æ•° =====
let localId = localStorage.getItem("localId");
if(!localId){ localId = crypto.randomUUID(); localStorage.setItem("localId", localId); }

let userId = localId; 
let studyStartTime = null;
let currentList = [];
let appMode = 'study'; 
let currentCorrectItem = null;
let studyTitle = ""; 

// === åˆ‡è¿«ãƒ¢ãƒ¼ãƒ‰ç”¨å¤‰æ•° ===
let urgentTimeouts = []; 
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// === ç¶´ã‚Šãƒ¢ãƒ¼ãƒ‰ç”¨å¤‰æ•° ===
let spellingOrder = [];
let spellingIndex = 0;
let spellingRound = 1;
let spellingMissList = []; 
let currentMaskedData = null; 
let spellingTargetWord = ""; 
let spellingHintText = ""; 

// ===== èªè¨¼ãƒ»åŒæœŸãƒ­ã‚¸ãƒƒã‚¯ (Auth) =====
auth.onAuthStateChanged(async (user) => {
  const btn = document.getElementById("authBtn");
  const msg = document.getElementById("authMsg");
  if (user) {
    userId = user.uid;
    msg.style.display = "none";
    btn.innerText = "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ (" + user.displayName + ")";
  } else {
    userId = localId;
    msg.style.display = "block";
    btn.innerText = "Googleã§ãƒ­ã‚°ã‚¤ãƒ³";
  }
  await loadAllLists();
});

function toggleAuth() {
  if (auth.currentUser) {
    if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) auth.signOut();
  } else {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(error => {
      alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + error.message);
    });
  }
}

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
const today = () => new Date().toISOString().slice(0,10);
const formatTime = sec => {
  const m = Math.floor(sec/60);
  const h = Math.floor(m/60);
  return h ? `${h}æ™‚é–“${m%60}åˆ†` : `${m}åˆ†`;
};
const hasJapanese = (str) => /[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾ ]/.test(str);
const toHalfWidth = (str) => {
    return str.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
    });
};
const isNum = (str) => /^[0-9]+$/.test(String(str).trim());

// ===== CSVèª­ã¿è¾¼ã¿ =====
async function loadCSV(path){
  if(path.startsWith("backup_")){ return null; }
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 2000); 

  try {
    const res = await fetch(path + "?t=" + Date.now(), { signal: controller.signal });
    clearTimeout(timeoutId);
    if (!res.ok) throw new Error("404");
    
    let text = await res.text();
    text = text.replace(/^\uFEFF/, ""); 
    const lines = text.trim().split("\n");
    if(lines.length < 2) return []; 
    const headers = lines[0].split(",").map(h=>h.trim());
    
    return lines.slice(1).map(l=>{
      const v=l.split(",");
      let o={};
      headers.forEach((h,i)=> {
        o[h] = v[i] ? v[i].trim() : "";
      });
      if(!o.word && headers[0]) o.word = o[headers[0]];
      if(!o.meaning && headers[1]) o.meaning = o[headers[1]];
      return o;
    });
  } catch(e) { return null; }
}

// ===== Firestoreé–¢é€£ =====
async function saveClearCount(title){
  if(!title) return;
  try{
    const ref=db.collection("users").doc(userId).collection("clearedLists").doc(title);
    const s=await ref.get();
    await ref.set({count:(s.exists?s.data().count:0)+1});
  }catch(e){}
}
async function loadClearCounts(){
  try{
    const s=await db.collection("users").doc(userId).collection("clearedLists").get();
    let m={}; s.forEach(d=>m[d.id]=d.data().count); return m;
  }catch(e){return {};}
}
async function saveStudyTime(sec){
  try{
    const ref=db.collection("users").doc(userId).collection("studyTime").doc(today());
    const s=await ref.get();
    await ref.set({seconds:(s.exists?s.data().seconds:0)+sec});
  }catch(e){}
}
async function loadStudyTimes(){
  try{
    const s=await db.collection("users").doc(userId).collection("studyTime").get();
    let m={}; s.forEach(d=>m[d.id]=d.data().seconds); return m;
  }catch(e){return {};}
}

// ===== è¡¨ç¤ºæ›´æ–° =====
async function updateStudyInfo(){
  const d=await loadStudyTimes();
  const t=d[today()]||0;
  const sum=Object.values(d).reduce((a,b)=>a+b,0);
  document.getElementById("studyInfo").innerText=`ğŸ“˜ ä»Šæ—¥ï¼š${formatTime(t)} / ç´¯è¨ˆï¼š${formatTime(sum)}`;
}

async function drawStudyChart(){
  const d=await loadStudyTimes();
  const e=Object.entries(d).sort().slice(-7);
  const c=document.getElementById("studyChart");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  if(!e.length) return;
  const vals=e.map(v=>Math.floor(v[1]/60));
  const max=Math.max(...vals,1);
  vals.forEach((v,i)=>{
    const h=v/max*120;
    ctx.fillStyle="#ff9bcd";
    ctx.fillRect(30+i*40,160-h,24,h);
    ctx.fillStyle="#555";
    ctx.fillText(e[i][0].slice(5),28+i*40,180);
  });
}

function setMode(mode){
  appMode = mode;
  ['study', 'game', 'urgent', 'spelling'].forEach(m => {
    const el = document.getElementById('mode' + m.charAt(0).toUpperCase() + m.slice(1));
    if(el) el.className = 'mode-option' + (mode === m ? ' mode-active' : '');
  });
  updateListVisibility();
}

function updateListVisibility() {
  const isSpelling = (appMode === 'spelling');
  const hInter = document.getElementById('headerInter');
  const lInter = document.getElementById('intermediateList');
  if(hInter) hInter.style.display = isSpelling ? 'none' : 'block';
  if(lInter) lInter.style.display = isSpelling ? 'none' : 'grid'; 
}

// ===== ãƒªã‚¹ãƒˆèª­è¾¼ =====
async function loadAllLists(){
  const statusDiv = document.getElementById("loadingStatus");
  statusDiv.innerText = "ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...";
  statusDiv.style.color = "blue";

  let basic = await loadCSV("lists/index.csv");
  let inter = await loadCSV("lists2/index.csv");
  
  let usedBackup = false;
  if(!basic) { basic = BACKUP_DATA.basic; usedBackup = true; }
  if(!inter) { inter = BACKUP_DATA.inter; usedBackup = true; }

  if(usedBackup){
    statusDiv.innerHTML = "âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼å¤±æ•—ã€‚<br>äºˆå‚™ãƒ‡ãƒ¼ã‚¿ã§èµ·å‹•ã—ã¾ã—ãŸã€‚";
    statusDiv.style.color = "red";
  } else {
    statusDiv.innerText = "âœ… èª­è¾¼å®Œäº†";
    statusDiv.style.color = "green";
    setTimeout(()=>statusDiv.style.display="none", 2000);
  }

  const counts = await loadClearCounts();
  
  const make=(data, folder, id)=>{
    const c=document.getElementById(id);
    c.innerHTML="";
    data.forEach(i=>{
      const b=document.createElement("button");
      b.className="btn-blue";
      const title = i.title || "No Title";
      b.innerText = title + (counts[title]?`ï¼ˆ${counts[title]}å›ã‚¯ãƒªã‚¢ï¼‰`:"");
      
      if(i.data){
        b.onclick = () => startSession(folder, title, i.file, i.data);
      } else {
        b.onclick = () => startSession(folder, title, i.file, null);
      }
      c.appendChild(b);
    });
  };
  
  make(basic, "lists", "basicList");
  make(inter, "lists2", "intermediateList");
  
  updateListVisibility(); 

  await updateStudyInfo();
  await drawStudyChart();
  show("listScreen");
}

async function startSession(folder, title, file, directData){
  studyStartTime = Date.now();
  
  if(directData){
    currentList = JSON.parse(JSON.stringify(directData));
  } else {
    currentList = await loadCSV(`${folder}/${file}`);
    if(!currentList){
      alert("ã“ã®ãƒªã‚¹ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      return;
    }
  }

  if(appMode === 'study'){
    startStudyMode(title);
  } else if(appMode === 'spelling'){
    startSpellingMode(title);
  } else {
    startGameMode(title);
  }
}

function setImage(containerId, imageUrl) {
  const container = document.getElementById(containerId);
  if(imageUrl && imageUrl.trim() !== "") {
    container.style.display = "flex";
    container.innerHTML = `<img src="${imageUrl}" alt="Hint Image">`;
  } else {
    container.style.display = "none";
    container.innerHTML = "";
  }
}

// ============================================
// âš¡ é€Ÿæ”»ï¼ˆã‚¯ã‚¤ãƒƒã‚¯ãƒãƒ£ãƒ¼ã‚¸ï¼‰ãƒ¢ãƒ¼ãƒ‰
// ============================================
let studyOrder=[], studyIndex=0, dontKnow=[], round=1;

function startStudyMode(t){
  studyTitle=t; round=1; studyIndex=0; dontKnow=[];
  studyOrder=[...currentList.keys()].sort(()=>Math.random()-0.5);
  show("studyScreen");
  nextQuestion();
}
function nextQuestion(){
  if(studyIndex>=studyOrder.length){
    if(!dontKnow.length){
      saveClearCount(studyTitle);
      alert("ã™ã¹ã¦æ­£è§£ã§ã™ï¼ã‚¯ãƒªã‚¢ï¼");
      return endStudy(true);
    }
    currentList=dontKnow.map(i=>currentList[i]);
    dontKnow=[]; round++; studyIndex=0;
    studyOrder=[...currentList.keys()];
  }
  const it=currentList[studyOrder[studyIndex]];
  document.getElementById("questionWord").innerText=it.word;
  document.getElementById("answerMeaning").innerText="";
  
  setImage("studyImageArea", it.image);
}
function markKnow(){ 
  showAnswer(); 
  forceSpeak(currentList[studyOrder[studyIndex]].meaning);
  setTimeout(()=>{studyIndex++;nextQuestion();},700); 
}
function markDontKnow(){ 
  dontKnow.push(studyOrder[studyIndex]); 
  showAnswer();
  forceSpeak(currentList[studyOrder[studyIndex]].meaning);
  setTimeout(()=>{studyIndex++;nextQuestion();},1200); 
}
function showAnswer(){ 
  document.getElementById("answerMeaning").innerText=currentList[studyOrder[studyIndex]].meaning; 
}

// ============================================
// ğŸ® 4æŠã‚²ãƒ¼ãƒ  & ğŸ”¥ ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼
// ============================================
let gameIndex=0, gameScore=0, gameOrder=[];

function startGameMode(t){
  studyTitle = t; // ã‚¿ã‚¤ãƒˆãƒ«ä¿å­˜
  gameIndex=0; gameScore=0;
  gameOrder=[...currentList.keys()].sort(()=>Math.random()-0.5);
  document.getElementById("gameScore").innerText = gameScore;
  show("gameScreen");
  nextGameQuestion();
}

function nextGameQuestion(){
  document.getElementById("gameFeedback").innerText = "";
  
  if(gameIndex >= gameOrder.length){
    let msg = `ã‚²ãƒ¼ãƒ çµ‚äº†ï¼\nã‚ãªãŸã®ã‚¹ã‚³ã‚¢: ${gameScore} / ${gameOrder.length}`;
    if(gameScore === gameOrder.length){
      saveClearCount(studyTitle);
      msg += "\n\nğŸ‰ Perfect!!\nã‚¯ãƒªã‚¢å›æ•°ã«è¿½åŠ ã—ã¾ã—ãŸï¼";
    }
    alert(msg);
    return endStudy(true);
  }
  
  const correctIdx = gameOrder[gameIndex];
  currentCorrectItem = currentList[correctIdx];
  
  document.getElementById("gameQuestionWord").style.display = "none";
  document.getElementById("gameQuestionWord").innerText = currentCorrectItem.word;
  document.getElementById("listeningMsg").style.display = "block";
  
  setImage("gameImageArea", currentCorrectItem.image);

  setTimeout(() => forceSpeak(currentCorrectItem.word), 400);

  stopUrgentTimer();
  if(appMode === 'urgent') {
    const startDelay = 2000;
    urgentTimeouts.push(setTimeout(playBeep, startDelay));            
    urgentTimeouts.push(setTimeout(playBeep, startDelay + 600));      
    urgentTimeouts.push(setTimeout(gameHint2, startDelay + 1200));    

    const phase2Start = startDelay + 1200 + 2000; 
    urgentTimeouts.push(setTimeout(playBeep, phase2Start));           
    urgentTimeouts.push(setTimeout(playBeep, phase2Start + 600));      
    urgentTimeouts.push(setTimeout(handleTimeUp, phase2Start + 1200)); 
  }

  let choices = [currentCorrectItem];
  let loop=0;
  while(choices.length < 4 && loop < 100){
    loop++;
    const r = Math.floor(Math.random() * currentList.length);
    const item = currentList[r];
    if(!choices.includes(item) && item.meaning !== currentCorrectItem.meaning){
      choices.push(item);
    }
  }
  choices.sort(()=>Math.random()-0.5);

  const area = document.getElementById("choicesArea");
  area.innerHTML = "";
  
  choices.forEach(c => {
    const btn = document.createElement("button");
    btn.className = "btn-choice";
    btn.innerText = c.meaning;
    btn.onclick = () => checkGameAnswer(c, currentCorrectItem);
    area.appendChild(btn);
  });
}

function gameHint1(){
  document.getElementById("listeningMsg").style.display = "none";
  document.getElementById("gameQuestionWord").style.display = "block";
  forceSpeak(currentCorrectItem.word);
}
function gameHint2(){ forceSpeak(currentCorrectItem.word); }
function gameHint3(){ forceSpeak(currentCorrectItem.meaning); }

function checkGameAnswer(selected, correct){
  stopUrgentTimer();
  
  const area = document.getElementById("choicesArea");
  Array.from(area.children).forEach(b => b.disabled = true);
  const feedback = document.getElementById("gameFeedback");

  const isLastQuestion = (gameIndex >= gameOrder.length - 1);
  let audioSequence = [];
  const correctAudioText = correct.meaning;

  if(selected.word === correct.word){
    gameScore++;
    document.getElementById("gameScore").innerText = gameScore;
    feedback.innerText = "â­• Excellent!";
    feedback.style.color = "green";
    
    audioSequence.push({text: "Good job!", lang: "en-US"});
    audioSequence.push({text: correctAudioText, lang: null}); 
    if(!isLastQuestion){
      audioSequence.push({text: "Let's go on to the next question.", lang: "en-US"});
    }
    playSequence(audioSequence, () => {
      gameIndex++;
      nextGameQuestion();
    });

  } else {
    feedback.innerText = `âŒ æ­£è§£: ${correct.meaning}`;
    feedback.style.color = "red";
    
    audioSequence.push({text: "Try again.", lang: "en-US"});
    audioSequence.push({text: correctAudioText, lang: null}); 
    audioSequence.push({text: "Next.", lang: "en-US"});
    playSequence(audioSequence, () => {
      gameIndex++;
      nextGameQuestion();
    });
  }
}

// ============================================
// âœï¸ ã‚¹ãƒšãƒªãƒ³ã‚°ï¼ˆç¶´ã‚Šï¼‰ãƒ¢ãƒ¼ãƒ‰
// ============================================

function startSpellingMode(t){
  studyTitle = t;
  spellingRound = 1;
  spellingIndex = 0;
  spellingMissList = [];
  spellingOrder = [...currentList.keys()].sort(()=>Math.random()-0.5);
  
  show("spellingScreen");
  nextSpellingQuestion();
}

function nextSpellingQuestion(){
  document.getElementById("spellingFeedback").innerText = "";
  
  const input = document.getElementById("inputAnswer");
  input.disabled = false; 
  input.value = "";
  
  document.getElementById("spellingRoundDisplay").innerText = spellingRound;

  if(spellingIndex >= spellingOrder.length){
    if(spellingRound === 1 && spellingMissList.length > 0){
      alert("1å·¡ç›®çµ‚äº†ï¼\né–“é•ãˆãŸå˜èªã®ã¿å†ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚");
      spellingRound = 2;
      spellingOrder = spellingMissList.map(item => currentList.indexOf(item));
      spellingMissList = []; 
      spellingIndex = 0;
      nextSpellingQuestion();
      return;
    } else {
      saveClearCount(studyTitle);
      alert("ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµ‚äº†ã§ã™ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼");
      return endStudy(true);
    }
  }

  const currentIdx = spellingOrder[spellingIndex];
  currentCorrectItem = currentList[currentIdx];

  // è‡ªå‹•åˆ¤åˆ¥
  const w = currentCorrectItem.word;
  const m = currentCorrectItem.meaning;
  
  let targetVal = w;
  let hintVal = m;

  if(hasJapanese(w) && !hasJapanese(m)){
      targetVal = m;
      hintVal = w;
  } else if (isNum(w) && !isNum(m)) {
      // wordãŒæ•°å­— -> meaning(è‹±èª)ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
      targetVal = m;
      hintVal = w;
  }
  
  spellingTargetWord = targetVal;
  spellingHintText = hintVal;

  currentMaskedData = createMaskedWord(spellingTargetWord);
  
  document.getElementById("spellingMeaning").innerText = spellingHintText;
  setImage("spellingImageArea", currentCorrectItem.image);
  document.getElementById("spellingQuestionText").innerText = currentMaskedData.displayed;
  
  input.maxLength = currentMaskedData.answer.length;
  input.focus();

  setTimeout(() => playSpellingAudio(), 400);
}

function playSpellingAudio() {
  forceSpeak(spellingTargetWord);
}

function createMaskedWord(word){
  if(!word) return { displayed: "??", answer: "??" };
  
  const isCon = c => /[bcdfghjklmnpqrstvwxyz]/i.test(c);
  let candidates = [];
  for(let i=0; i < word.length - 1; i++){
    if(isCon(word[i]) && isCon(word[i+1])){
      candidates.push(i);
    }
  }

  let targetIndex = 0;
  let targetLen = 2;

  if(candidates.length > 0){
    targetIndex = candidates[Math.floor(Math.random() * candidates.length)];
  } else {
    targetIndex = 0;
    targetLen = Math.min(2, word.length);
  }

  const answerStr = word.substr(targetIndex, targetLen);
  const maskedStr = word.substring(0, targetIndex) + "__" + word.substring(targetIndex + targetLen);

  return { displayed: maskedStr, answer: answerStr };
}

function checkSpellingAnswer(){
  const input = document.getElementById("inputAnswer");
  
  if(input.disabled) return;
  input.disabled = true; 
  
  const feedback = document.getElementById("spellingFeedback");
  
  const rawInput = input.value;
  const normalizedInput = toHalfWidth(rawInput).trim();
  const correctVal = currentMaskedData.answer;

  let audioSequence = [];
  
  const hasNext = (spellingIndex < spellingOrder.length - 1);

  if (normalizedInput === correctVal) {
      // === æ­£è§£ ===
      feedback.innerText = "â­• Good job!";
      feedback.style.color = "green";
      
      audioSequence.push({text: "Good job!", lang: "en-US"});
      
  } else {
      // === ä¸æ­£è§£ã¾ãŸã¯æƒœã—ã„ ===
      let isNearly = false;
      let msgText = "Try again.";
      
      if (normalizedInput.toLowerCase() === correctVal.toLowerCase()) {
          msgText = "Nearly.";
          isNearly = true;
      }
      else if (correctVal.length === 2 && normalizedInput.length === 2) {
          let matchCount = 0;
          if (normalizedInput[0] === correctVal[0]) matchCount++;
          if (normalizedInput[1] === correctVal[1]) matchCount++;
          if (matchCount === 1) {
               msgText = "Nearly!";
               isNearly = true;
          }
      }

      feedback.innerText = isNearly ? `âš ï¸ ${msgText}` : `âŒ ${msgText}`;
      feedback.style.color = isNearly ? "#e6ae00" : "red";
      
      audioSequence.push({text: msgText, lang: "en-US"});

      // ä¸æ­£è§£ãªã‚‰ãƒªã‚¹ãƒˆè¿½åŠ 
      if(spellingRound === 1){
        if(!spellingMissList.includes(currentCorrectItem)){
            spellingMissList.push(currentCorrectItem);
        }
      }
  }

  // å¿…ãšæ­£è§£å˜èªã‚’æµã™
  audioSequence.push({text: spellingTargetWord, lang: "en-US"});

  // æ¬¡ã¸é€²ã‚€éŸ³å£°
  if(hasNext) {
    audioSequence.push({text: "Next question.", lang: "en-US"});
  }

  playSequence(audioSequence, () => {
      spellingIndex++;
      nextSpellingQuestion();
  });
}

// === åˆ‡è¿«ãƒ¢ãƒ¼ãƒ‰ä¾¿åˆ©é–¢æ•° ===
function playBeep() {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.type = 'square';
  osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.1);
}

function stopUrgentTimer() {
  urgentTimeouts.forEach(id => clearTimeout(id));
  urgentTimeouts = [];
}

function handleTimeUp() {
  const feedback = document.getElementById("gameFeedback");
  feedback.innerText = "â° TIME UP!!";
  feedback.style.color = "red";
  const area = document.getElementById("choicesArea");
  Array.from(area.children).forEach(b => b.disabled = true);
  let audioSequence = [];
  audioSequence.push({text: "Time's up.", lang: "en-US"});
  audioSequence.push({text: currentCorrectItem.meaning, lang: null}); 
  audioSequence.push({text: "Next.", lang: "en-US"});
  playSequence(audioSequence, () => {
    gameIndex++;
    nextGameQuestion();
  });
}

// ===== å†ç”Ÿé–¢é€£ =====
function playSequence(list, onComplete){
  speechSynthesis.cancel();
  let index = 0;
  function playNext(){
    if(index >= list.length){
      if(onComplete) onComplete();
      return;
    }
    const item = list[index];
    const u = new SpeechSynthesisUtterance(item.text);
    if(item.lang) u.lang = item.lang;
    else u.lang = /[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾ ]/.test(item.text) ? "ja-JP" : "en-US";
    u.rate = 1.0;
    u.onend = function(){
      index++;
      setTimeout(playNext, 300); // é€£ç¶šå†ç”Ÿã®é–“éš”
    };
    u.onerror = function(){
      index++;
      playNext();
    };
    speechSynthesis.speak(u);
  }
  playNext();
}

function forceSpeak(t){
    if(!t) return;
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(t);
    u.lang = /[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾ ]/.test(t) ? "ja-JP" : "en-US";
    speechSynthesis.speak(u);
}

function speakQuestion(){ 
  speechSynthesis.cancel();
  if(appMode==='study') forceSpeak(document.getElementById("questionWord").innerText);
  else forceSpeak(document.getElementById("gameQuestionWord").innerText);
}
function speakAnswer(){ 
  speechSynthesis.cancel();
  if(appMode==='study') forceSpeak(document.getElementById("answerMeaning").innerText);
}

async function endStudy(auto){
  stopUrgentTimer();
  if(studyStartTime){
    await saveStudyTime(Math.floor((Date.now()-studyStartTime)/1000));
    studyStartTime=null;
  }
  if(!auto && !confirm("å­¦ç¿’ã‚’çµ‚äº†ã—ã¦ä¸€è¦§ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) return;
  loadAllLists();
}
function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}
</script>
</body>
</html>

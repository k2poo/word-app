<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>è‹±å˜èªæš—è¨˜ã‚¢ãƒ—ãƒª by Koji NIHEI 2026</title>

<!-- ===== Firebase CDN ===== -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#fff5fb;
  padding:2vw;
}
.screen{ display:none; }
.card{
  background:white;
  padding:3vw;
  border-radius:18px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
  margin-bottom:4vw;
}
button{
  padding:2.5vw 4vw;
  border-radius:20px;
  border:none;
  font-size:4vw;
  margin:1vw;
}
.btn-blue{ background:#9bd8ff; }
.btn-green{ background:#9be1a7; }
.btn-pink{ background:#ff9bcd; }
.btn-gray{ background:#dddddd; }

.big{
  font-size:7vw;
  margin:3vw 0;
  text-align:center;
  cursor:pointer;
}
#wordImage{
  max-width:70%;
  display:none;
  margin:3vw auto;
}
#infoBar{
  position:fixed;
  bottom:1.5vw;
  right:1.5vw;
  background:rgba(255,255,255,0.95);
  border-radius:12px;
  padding:1.5vw 2vw;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}
canvas{ max-width:100%; }
</style>
</head>

<body>

<div id="listScreen" class="screen card">
  <h3>ğŸ“˜ åŸºæœ¬</h3>
  <div id="basicList"></div>
</div>

<div id="studyScreen" class="screen card">
  <div class="big" id="questionWord" onclick="speakWord()"></div>
  <img id="wordImage">
  <div class="big" id="answerMeaning" onclick="speakMeaning()"></div>

  <button class="btn-green" onclick="markKnow()">åˆ†ã‹ã‚‹</button>
  <button class="btn-pink" onclick="markDontKnow()">åˆ†ã‹ã‚‰ãªã„</button>
  <button class="btn-gray" onclick="endStudy()">çµ‚äº†</button>
</div>

<div class="card">
  <div id="todayTime"></div>
  <div id="totalTime"></div>
  <canvas id="graph" height="200"></canvas>
</div>

<script>
/* ================= Firebase ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAYEEHtYUdDylKlSwy4mX2S2mIK5Hs3vJA",
  authDomain: "english-word-app-f7101.firebaseapp.com",
  projectId: "english-word-app-f7101"
});
const db = firebase.firestore();

/* ================= User ================= */
let userId = localStorage.getItem("userId");
if(!userId){
  userId = crypto.randomUUID();
  localStorage.setItem("userId",userId);
}

/* ================= CSV ================= */
async function loadCSV(path){
  const t = await (await fetch(path)).text();
  const l = t.trim().split("\n");
  const h = l[0].split(",");
  return l.slice(1).map(r=>{
    const v=r.split(",");
    let o={};
    h.forEach((k,i)=>o[k]=v[i]);
    return o;
  });
}

/* ================= Study ================= */
let list=[],order=[],i=0,startTime=0;

async function startStudy(file){
  list = await loadCSV(file);
  order=[...list.keys()].sort(()=>Math.random()-0.5);
  i=0;
  startTime=Date.now();
  show("studyScreen");
  next();
}

function next(){
  if(i>=order.length){
    saveTime();
    show("listScreen");
    return;
  }
  const item=list[order[i]];
  questionWord.innerText=item.word;
  answerMeaning.innerText="";
}

function markKnow(){ i++; next(); }
function markDontKnow(){ i++; next(); }

/* ================= Speech (FIXED) ================= */
function speakWord(){
  speak(questionWord.innerText,"en-US");
}
function speakMeaning(){
  speak(answerMeaning.innerText,"ja-JP");
}
function speak(text,lang){
  if(!text) return;
  speechSynthesis.cancel();      // â† â˜…è¶…é‡è¦
  const u=new SpeechSynthesisUtterance(text);
  u.lang=lang;
  speechSynthesis.speak(u);
}

/* ================= Time ================= */
async function saveTime(){
  const sec=Math.floor((Date.now()-startTime)/1000);
  const d=new Date().toISOString().slice(0,10);
  const ref=db.collection("users").doc(userId);
  await ref.set({
    total:firebase.firestore.FieldValue.increment(sec),
    [d]:firebase.firestore.FieldValue.increment(sec)
  },{merge:true});
  loadStats();
}

/* ================= Stats & Graph ================= */
async function loadStats(){
  const d=(await db.collection("users").doc(userId).get()).data();
  if(!d) return;
  todayTime.innerText="ä»Šæ—¥ï¼š"+(d[new Date().toISOString().slice(0,10)]||0)+"ç§’";
  totalTime.innerText="ç´¯è¨ˆï¼š"+(d.total||0)+"ç§’";
  drawGraph(d);
}

function drawGraph(data){
  const c=graph.getContext("2d");
  c.clearRect(0,0,graph.width,graph.height);
  const days=Object.keys(data).filter(k=>k!=="total").sort();
  days.forEach((d,i)=>{
    c.fillRect(i*30,200-data[d]/10,20,data[d]/10);
    c.fillText(d.slice(5),i*30,195);
  });
}

/* ================= UI ================= */
function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}

/* ================= Init ================= */
basicList.innerHTML='<button class="btn-blue" onclick="startStudy(\'lists/basic.csv\')">åŸºæœ¬å˜èª</button>';
show("listScreen");
loadStats();
</script>
</body>
</html>

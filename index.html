<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>è‹±å˜èªæš—è¨˜ã‚¢ãƒ—ãƒª by Koji NIHEI 2026</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#fff5fb;
  padding:2vw;
}
.screen{ display:none; }
.card{
  background:white;
  padding:3vw;
  border-radius:18px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
  margin-bottom:4vw;
}
button{
  padding:2.5vw 4vw;
  border-radius:20px;
  border:none;
  font-size:4vw;
  margin:1vw;
}
.btn-blue{ background:#9bd8ff; }
.btn-green{ background:#9be1a7; }
.btn-pink{ background:#ff9bcd; }
.btn-gray{ background:#dddddd; }
.big{
  font-size:7vw;
  margin:3vw 0;
  text-align:center;
  cursor:pointer;
}
#wordImage{
  max-width:70%;
  display:none;
  margin:3vw auto;
}
#infoBar{
  position:fixed;
  bottom:1.5vw;
  right:1.5vw;
  background:rgba(255,255,255,0.9);
  border-radius:12px;
  padding:1.5vw 2vw;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}
#studyInfo{ font-size:3vw; color:#555; }
</style>
</head>

<body>

<!-- ===== ãƒªã‚¹ãƒˆé¸æŠ ===== -->
<div id="listScreen" class="screen card">
  <h3>ğŸ“˜ åŸºæœ¬</h3>
  <div id="basicList"></div>

  <h3>ğŸ“• ä¸­ç´š</h3>
  <div id="intermediateList"></div>

  <h3>ğŸ“Š å­¦ç¿’æ™‚é–“ï¼ˆæ—¥åˆ¥ï¼‰</h3>
  <canvas id="studyChart" width="300" height="200"></canvas>
</div>

<!-- ===== å­¦ç¿’ç”»é¢ ===== -->
<div id="studyScreen" class="screen card">
  <div class="big" id="questionWord" onclick="speakQuestion()"></div>
  <img id="wordImage" onclick="speakQuestion()">
  <div class="big" id="answerMeaning" style="color:#0077ff;"
       onclick="speakAnswer()"></div>

  <button class="btn-green" onclick="markKnow()">åˆ†ã‹ã‚‹</button>
  <button class="btn-pink" onclick="markDontKnow()">åˆ†ã‹ã‚‰ãªã„</button>
  <button class="btn-gray" onclick="endStudy()">çµ‚äº†</button>
</div>

<div id="infoBar">
  <div>ğŸŒ¸ è‹±å˜èªæš—è¨˜ã‚¢ãƒ—ãƒª by Koji NIHEI 2026 ğŸŒ¸</div>
  <div id="studyInfo"></div>
</div>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ===== Firebase åˆæœŸåŒ– =====
firebase.initializeApp({
  apiKey: "AIzaSyAYEEHtYUdDylKlSwy4mX2S2mIK5Hs3vJA",
  authDomain: "english-word-app-f7101.firebaseapp.com",
  projectId: "english-word-app-f7101",
});
const db = firebase.firestore();

// ===== userId =====
let userId = localStorage.getItem("userId");
if(!userId){
  userId = crypto.randomUUID();
  localStorage.setItem("userId", userId);
}

// ===== å…±é€š =====
let studyStartTime = null;
function getToday(){
  return new Date().toISOString().slice(0,10);
}
function formatTime(sec){
  const m=Math.floor(sec/60), h=Math.floor(m/60);
  return h>0 ? `${h}æ™‚é–“${m%60}åˆ†` : `${m}åˆ†`;
}

// ===== CSV =====
async function loadCSV(path){
  const res=await fetch(path);
  const lines=(await res.text()).trim().split("\n");
  const h=lines[0].split(",");
  return lines.slice(1).map(l=>{
    const v=l.split(",");
    let o={}; h.forEach((k,i)=>o[k]=v[i]); return o;
  });
}

// ===== Firestore =====
async function saveClearCount(name){
  const ref=db.collection("users").doc(userId)
    .collection("clearedLists").doc(name);
  const s=await ref.get();
  await ref.set({count:(s.exists?s.data().count:0)+1});
}
async function loadClearCounts(){
  const s=await db.collection("users").doc(userId)
    .collection("clearedLists").get();
  let m={}; s.forEach(d=>m[d.id]=d.data().count); return m;
}
async function saveStudyTime(sec){
  const d=getToday();
  const ref=db.collection("users").doc(userId)
    .collection("studyTime").doc(d);
  const s=await ref.get();
  await ref.set({seconds:(s.exists?s.data().seconds:0)+sec});
}
async function loadStudyTimes(){
  const s=await db.collection("users").doc(userId)
    .collection("studyTime").get();
  let m={}; s.forEach(d=>m[d.id]=d.data().seconds); return m;
}

// ===== è¡¨ç¤º =====
async function updateStudyInfo(){
  const d=await loadStudyTimes();
  const t=d[getToday()]||0;
  const sum=Object.values(d).reduce((a,b)=>a+b,0);
  document.getElementById("studyInfo").innerText=
    `ğŸ“Š ä»Šæ—¥ï¼š${formatTime(t)} / ç´¯è¨ˆï¼š${formatTime(sum)}`;
}
async function drawStudyChart(){
  const d=await loadStudyTimes();
  const e=Object.entries(d).sort().slice(-7);
  const c=document.getElementById("studyChart");
  const x=c.getContext("2d");
  x.clearRect(0,0,c.width,c.height);
  if(!e.length) return;
  const v=e.map(i=>Math.floor(i[1]/60));
  const m=Math.max(...v,1);
  const p=30,w=c.width-p*2,h=c.height-p*2;
  v.forEach((val,i)=>{
    const bh=val/m*h;
    x.fillStyle="#ff9bcd";
    x.fillRect(p+i*w/v.length,h+p-bh,w/v.length*0.6,bh);
    x.fillStyle="#555";
    x.fillText(e[i][0].slice(5),p+i*w/v.length+10,c.height-5);
  });
}

// ===== å­¦ç¿’ =====
let currentList=[],order=[],index=0,dontKnow=[],title="";
async function loadAllLists(){
  const basic=await loadCSV("lists/index.csv");
  const inter=await loadCSV("lists2/index.csv");
  const counts=await loadClearCounts();
  function make(data,folder,id){
    const c=document.getElementById(id); c.innerHTML="";
    data.forEach(i=>{
      const b=document.createElement("button");
      b.className="btn-blue";
      b.innerText=i.title+(counts[i.title]?` âœ… ${counts[i.title]}å›ã‚¯ãƒªã‚¢`:"");
      b.onclick=()=>startStudy(folder,i.title,i.file);
      c.appendChild(b);
    });
  }
  make(basic,"lists","basicList");
  make(inter,"lists2","intermediateList");
  await updateStudyInfo();
  await drawStudyChart();
  show("listScreen");
}
async function startStudy(folder,t,file){
  studyStartTime=Date.now();
  currentList=await loadCSV(`${folder}/${file}`);
  title=t; index=0; dontKnow=[];
  order=[...currentList.keys()].sort(()=>Math.random()-0.5);
  show("studyScreen"); nextQuestion();
}
async function nextQuestion(){
  if(index>=order.length){
    if(!dontKnow.length){
      await saveClearCount(title);
      alert("ã™ã¹ã¦æ­£è§£ã§ã™ï¼");
      return loadAllLists();
    }
    currentList=dontKnow.map(i=>currentList[i]);
    dontKnow=[]; index=0;
  }
  const it=currentList[order[index]];
  questionWord.innerText=it.word;
  answerMeaning.innerText="";
}
function markKnow(){ showAnswer(); setTimeout(()=>{index++;nextQuestion();},800); }
function markDontKnow(){ dontKnow.push(order[index]); showAnswer(); setTimeout(()=>{index++;nextQuestion();},1500); }
function showAnswer(){ answerMeaning.innerText=currentList[order[index]].meaning; }

// ===== éŸ³å£° =====
function speak(t){ if(!t) return; let u=new SpeechSynthesisUtterance(t); u.lang="en-US"; speechSynthesis.speak(u); }
function speakQuestion(){ speak(questionWord.innerText); }
function speakAnswer(){ speak(answerMeaning.innerText); }

// ===== çµ‚äº† =====
async function endStudy(){
  if(!confirm("å­¦ç¿’ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ")) return;
  if(studyStartTime){
    await saveStudyTime(Math.floor((Date.now()-studyStartTime)/1000));
    studyStartTime=null;
  }
  loadAllLists();
}
function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}

// èµ·å‹•
loadAllLists();
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>è‹±å˜èªæš—è¨˜ã‚¢ãƒ—ãƒª by Koji NIHEI 2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
body{
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background:#fff5fb;
  padding:2vw;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}
.screen{ display:none; }
.card{
  background:white;
  padding:3vw;
  border-radius:18px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
  margin-bottom:4vw;
}
h3 {
  font-size: 4.5vw;
  color: #444;
  margin: 4vw 1vw 2vw 1vw;
  border-left: 5px solid #ff9bcd;
  padding-left: 10px;
}
button{
  padding:3vw 5vw;
  border-radius:20px;
  border:none;
  font-size:4vw;
  margin:1.5vw;
  cursor: pointer;
  transition: transform 0.1s, opacity 0.1s;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
button:active{ transform: scale(0.96); opacity: 0.8; }

.btn-blue{ background:#9bd8ff; color:#004085; width: 90%; text-align:left; }
.btn-green{ background:#9be1a7; color:#155724; }
.btn-pink{ background:#ff9bcd; color:#721c24; }
.btn-gray{ background:#dddddd; color:#333; }

/* ã‚²ãƒ¼ãƒ ç”¨é¸æŠè‚¢ãƒœã‚¿ãƒ³ */
.btn-choice{
  width: 100%;
  margin: 2vw 0;
  padding: 4vw;
  font-size: 5vw;
  background: #f0f8ff;
  border: 2px solid #9bd8ff;
  border-radius: 12px;
  color: #333;
  text-align: left;
  font-weight: bold;
}

/* ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ */
.hint-area {
  display: flex;
  justify-content: space-around;
  margin-bottom: 3vw;
}
.btn-hint {
  background: #fff3cd;
  color: #856404;
  border: 1px solid #ffeeba;
  font-size: 3.5vw;
  padding: 2vw 1vw;
  border-radius: 12px;
  width: 30%;
}

.big{
  font-size:10vw;
  margin:6vw 0;
  text-align:center;
  cursor:pointer;
  font-weight: bold;
  word-break: break-word;
  min-height: 12vw; 
}
/* éŸ³å£°å‡ºé¡Œä¸­ã®è¡¨ç¤º */
.listening-msg {
  font-size: 5vw;
  color: #ff9bcd;
  animation: pulse 1.5s infinite;
  text-align: center;
  font-weight: bold;
}
@keyframes pulse {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}

#infoBar{
  position:fixed;
  bottom:0;
  left: 0;
  width: 100%;
  background:rgba(255,255,255,0.95);
  border-top: 1px solid #eee;
  padding:3vw;
  text-align: center;
  box-shadow:0 -2px 6px rgba(0,0,0,0.05);
  font-size: 3.5vw;
  z-index: 100;
  box-sizing: border-box;
}

.mode-switch {
  display: flex;
  justify-content: center;
  margin-bottom: 4vw;
  background: #eee;
  border-radius: 25px;
  padding: 1vw;
}
.mode-option {
  flex: 1;
  text-align: center;
  padding: 2.5vw;
  border-radius: 20px;
  cursor: pointer;
  font-size: 4vw;
  color: #888;
  transition: 0.3s;
}
.mode-active {
  background: #ff9bcd;
  color: white;
  font-weight: bold;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}

.score-board {
  text-align: center;
  font-size: 6vw;
  color: #ff9bcd;
  font-weight: bold;
  margin-bottom: 2vw;
}

/* èª­ã¿è¾¼ã¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
#loadingStatus {
    font-size: 3vw;
    color: #666;
    text-align: center;
    padding: 2vw;
    background: #f8f9fa;
    margin-bottom: 2vw;
    border-radius: 8px;
}
</style>
</head>

<body>

<div id="listScreen" class="screen" style="display:block;">
  <div class="card">
    <div style="text-align:center; font-size:5vw; font-weight:bold; margin-bottom:4vw; color:#555;">
      è‹±å˜èªã‚¢ãƒ—ãƒª 2026
    </div>
    
    <div class="mode-switch">
      <div id="modeStudy" class="mode-option mode-active" onclick="setMode('study')">âš¡ é€Ÿæ”»</div>
      <div id="modeGame" class="mode-option" onclick="setMode('game')">ğŸ® ã‚²ãƒ¼ãƒ </div>
    </div>
    
    <div style="text-align:center; font-size:3.5vw; color:#888; margin-bottom:2vw;">
      ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã‹ã‚‰<br>ä¸‹ã®ãƒªã‚¹ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„
    </div>

    <div id="loadingStatus">æº–å‚™ä¸­...</div>
  </div>

  <div class="card">
    <h3>ğŸ“˜ åŸºæœ¬ã‚³ãƒ¼ã‚¹</h3>
    <div id="basicList" style="text-align:center;"></div>

    <h3>ğŸ“• ä¸­ç´šã‚³ãƒ¼ã‚¹</h3>
    <div id="intermediateList" style="text-align:center;"></div>
  </div>

  <div class="card">
    <h3>ğŸ“Š å­¦ç¿’è¨˜éŒ²</h3>
    <div style="text-align:center;">
        <canvas id="studyChart" width="320" height="200"></canvas>
    </div>
  </div>
  
  <div style="height:15vw;"></div>
</div>

<div id="studyScreen" class="screen card" style="min-height: 80vh;">
  <div style="text-align:center;color:#888;margin-bottom:4vw;">âš¡ é€Ÿæ”»ãƒ¢ãƒ¼ãƒ‰</div>
  
  <div class="big" id="questionWord" onclick="speakQuestion()"></div>
  <div class="big" id="answerMeaning" style="color:#0077ff;" onclick="speakAnswer()"></div>

  <div style="text-align:center; margin-top:10vw;">
    <button class="btn-green" onclick="markKnow()">åˆ†ã‹ã‚‹</button>
    <button class="btn-pink" onclick="markDontKnow()">åˆ†ã‹ã‚‰ãªã„</button>
  </div>
  <div style="text-align:center; margin-top:8vw;">
    <button class="btn-gray" onclick="endStudy()">çµ‚äº†ã—ã¦æˆ»ã‚‹</button>
  </div>
</div>

<div id="gameScreen" class="screen card" style="min-height: 80vh;">
  <div class="score-board">SCORE: <span id="gameScore">0</span></div>
  
  <div style="min-height:20vw; display:flex; align-items:center; justify-content:center; margin-bottom:4vw;">
      <div id="listeningMsg" class="listening-msg">ğŸµ ã‚ˆãèã„ã¦<br>(éŸ³å£°ã§å‡ºé¡Œä¸­)</div>
      <div id="gameQuestionWord" class="big" style="display:none; margin:0;"></div>
  </div>

  <div class="hint-area">
      <button class="btn-hint" onclick="gameHint1()">ãƒ’ãƒ³ãƒˆ1<br>æ–‡å­—ã‚’è¡¨ç¤º</button>
      <button class="btn-hint" onclick="gameHint2()">ãƒ’ãƒ³ãƒˆ2<br>ã‚‚ã†ä¸€åº¦èã</button>
      <button class="btn-hint" onclick="gameHint3()">ãƒ’ãƒ³ãƒˆ3<br>ç­”ãˆã‚’èã</button>
  </div>
  
  <div id="choicesArea"></div>

  <div id="gameFeedback" style="text-align:center; font-size:4.5vw; height:8vw; margin-top:2vw; font-weight:bold; color:red;"></div>

  <div style="text-align:center; margin-top:8vw;">
    <button class="btn-gray" onclick="endStudy()">çµ‚äº†ã—ã¦æˆ»ã‚‹</button>
  </div>
</div>

<div id="infoBar">
  <div id="studyInfo">...</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ===== â˜…ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ãƒ‡ãƒ¼ã‚¿ (ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼å¤±æ•—æ™‚ã«ä½¿ç”¨) â˜… =====
const BACKUP_DATA = {
  basic: [
    {title: "åŸºæœ¬å˜èª1(Backup)", file:"backup_basic", data:[{word:"Apple",meaning:"ã‚Šã‚“ã”"},{word:"Dog",meaning:"çŠ¬"},{word:"Cat",meaning:"çŒ«"},{word:"Run",meaning:"èµ°ã‚‹"}]},
    {title: "åŸºæœ¬å˜èª2(Backup)", file:"backup_basic2", data:[{word:"Hello",meaning:"ã“ã‚“ã«ã¡ã¯"},{word:"Thank you",meaning:"ã‚ã‚ŠãŒã¨ã†"}]}
  ],
  inter: [
    {title: "ä¸­ç´šå˜èª1(Backup)", file:"backup_inter", data:[{word:"Understand",meaning:"ç†è§£ã™ã‚‹"},{word:"Difficult",meaning:"é›£ã—ã„"}]}
  ]
};

// ===== Firebase =====
try {
  firebase.initializeApp({
    apiKey: "AIzaSyAYEEHtYUdDylKlSwy4mX2S2mIK5Hs3vJA",
    authDomain: "english-word-app-f7101.firebaseapp.com",
    projectId: "english-word-app-f7101",
  });
} catch(e) { console.error(e); }
const db = firebase.firestore();

// ===== å¤‰æ•° =====
let userId = localStorage.getItem("userId");
if(!userId){ userId = crypto.randomUUID(); localStorage.setItem("userId", userId); }
let studyStartTime = null;
let currentList = [];
let appMode = 'study'; 
let currentCorrectItem = null;

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
const today = () => new Date().toISOString().slice(0,10);
const formatTime = sec => {
  const m = Math.floor(sec/60);
  const h = Math.floor(m/60);
  return h ? `${h}æ™‚é–“${m%60}åˆ†` : `${m}åˆ†`;
};

// ===== CSVèª­ã¿è¾¼ã¿ (ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ã) =====
async function loadCSV(path){
  // å†…è”µãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã®åˆ¤åˆ¥
  if(path.startsWith("backup_")){ return null; }

  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 2000); // 2ç§’ã§è«¦ã‚ã‚‹

  try {
    const res = await fetch(path + "?t=" + Date.now(), { signal: controller.signal });
    clearTimeout(timeoutId);
    if (!res.ok) throw new Error("404");
    
    let text = await res.text();
    text = text.replace(/^\uFEFF/, ""); 
    const lines = text.trim().split("\n");
    if(lines.length < 2) return []; 
    const headers = lines[0].split(",").map(h=>h.trim());
    return lines.slice(1).map(l=>{
      const v=l.split(",");
      let o={};
      headers.forEach((h,i)=>o[h]=v[i]?v[i].trim():"");
      return o;
    });
  } catch(e) {
    return null; // å¤±æ•—ã—ãŸã‚‰nullã‚’è¿”ã™
  }
}

// ===== Firestoreé–¢é€£ =====
async function saveClearCount(title){
  try{
    const ref=db.collection("users").doc(userId).collection("clearedLists").doc(title);
    const s=await ref.get();
    await ref.set({count:(s.exists?s.data().count:0)+1});
  }catch(e){}
}
async function loadClearCounts(){
  try{
    const s=await db.collection("users").doc(userId).collection("clearedLists").get();
    let m={}; s.forEach(d=>m[d.id]=d.data().count); return m;
  }catch(e){return {};}
}
async function saveStudyTime(sec){
  try{
    const ref=db.collection("users").doc(userId).collection("studyTime").doc(today());
    const s=await ref.get();
    await ref.set({seconds:(s.exists?s.data().seconds:0)+sec});
  }catch(e){}
}
async function loadStudyTimes(){
  try{
    const s=await db.collection("users").doc(userId).collection("studyTime").get();
    let m={}; s.forEach(d=>m[d.id]=d.data().seconds); return m;
  }catch(e){return {};}
}

// ===== è¡¨ç¤ºæ›´æ–° =====
async function updateStudyInfo(){
  const d=await loadStudyTimes();
  const t=d[today()]||0;
  const sum=Object.values(d).reduce((a,b)=>a+b,0);
  document.getElementById("studyInfo").innerText=`ğŸ“˜ ä»Šæ—¥ï¼š${formatTime(t)} / ç´¯è¨ˆï¼š${formatTime(sum)}`;
}

async function drawStudyChart(){
  const d=await loadStudyTimes();
  const e=Object.entries(d).sort().slice(-7);
  const c=document.getElementById("studyChart");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  if(!e.length) return;
  const vals=e.map(v=>Math.floor(v[1]/60));
  const max=Math.max(...vals,1);
  vals.forEach((v,i)=>{
    const h=v/max*120;
    ctx.fillStyle="#ff9bcd";
    ctx.fillRect(30+i*40,160-h,24,h);
    ctx.fillStyle="#555";
    ctx.fillText(e[i][0].slice(5),28+i*40,180);
  });
}

function setMode(mode){
  appMode = mode;
  document.getElementById('modeStudy').className = mode === 'study' ? 'mode-option mode-active' : 'mode-option';
  document.getElementById('modeGame').className = mode === 'game' ? 'mode-option mode-active' : 'mode-option';
}

// ===== â˜…ãƒªã‚¹ãƒˆèª­è¾¼ (ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼)â˜… =====
async function loadAllLists(){
  const statusDiv = document.getElementById("loadingStatus");
  statusDiv.innerText = "ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...";
  statusDiv.style.color = "blue";

  // 1. ã¾ãšãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿ã«è¡Œã
  let basic = await loadCSV("lists/index.csv");
  let inter = await loadCSV("lists2/index.csv");
  
  // 2. å¤±æ•—ã—ã¦ã„ãŸã‚‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½¿ã†
  let usedBackup = false;
  if(!basic) { basic = BACKUP_DATA.basic; usedBackup = true; }
  if(!inter) { inter = BACKUP_DATA.inter; usedBackup = true; }

  // 3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
  if(usedBackup){
    statusDiv.innerHTML = "âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼å¤±æ•—ã€‚<br>äºˆå‚™ãƒ‡ãƒ¼ã‚¿ã§èµ·å‹•ã—ã¾ã—ãŸã€‚<br>(ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã‚’ç¢ºèªã—ã¦ãã ã•ã„)";
    statusDiv.style.color = "red";
  } else {
    statusDiv.innerText = "âœ… èª­è¾¼å®Œäº†";
    statusDiv.style.color = "green";
    setTimeout(()=>statusDiv.style.display="none", 2000);
  }

  const counts = await loadClearCounts();
  
  const make=(data, folder, id)=>{
    const c=document.getElementById(id);
    c.innerHTML="";
    data.forEach(i=>{
      const b=document
